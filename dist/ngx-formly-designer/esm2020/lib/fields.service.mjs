import { Injectable } from '@angular/core';
import { cloneDeep, equalType, generateUuid, getKeyPath, isArray, isString } from './util';
import * as i0 from "@angular/core";
import * as i1 from "./formly-designer-config";
export class FieldsService {
    constructor(formlyDesignerConfig) {
        this.formlyDesignerConfig = formlyDesignerConfig;
    }
    getFullKeyPath(field, fields) {
        let keyPath = [];
        if (field && field.key) {
            const parents = new Map();
            this.traverseFields(fields, (f, path, parent) => {
                parent && parents.set(f, parent);
            });
            keyPath = getKeyPath(field);
            let cur = parents.get(field);
            while (cur) {
                keyPath = getKeyPath(cur).concat(keyPath);
                cur = parents.get(cur);
            }
        }
        return keyPath;
    }
    getTypeFields(type) {
        return this.getFields(type, 'type');
    }
    getWrapperFields(wrapper) {
        return wrapper ? this.getFields(wrapper, 'wrapper') : [];
    }
    checkField(field, fields, parent) {
        if (field.key == null || (isString(field.key) && !field.key) || (isArray(field.key) && !field.key.length)) {
            return true;
        }
        const fullPathByField = new Map();
        const newPath = this.getFullKeyPath(parent || {}, fields).concat(getKeyPath(field));
        const length = newPath.length;
        return !this.traverseFields(fields, (f, p) => {
            const path = fullPathByField.get(f) || fullPathByField.set(f, (p || []).concat(getKeyPath(f))).get(f);
            if (path?.length !== length) {
                return;
            }
            for (let i = 0; i < length; i++) {
                if (path[i] !== newPath[i]) {
                    return;
                }
            }
            return !equalType(field, f);
        });
    }
    find(id, fields) {
        if (!id || !isArray(fields)) {
            return;
        }
        const stack = fields.slice();
        while (stack.length) {
            const field = stack.pop();
            if (field.templateOptions?.['$designerId'] === id) {
                return field;
            }
            if (field.fieldArray) {
                stack.push(field.fieldArray);
            }
            else if (field.fieldGroup) {
                stack.push(...field.fieldGroup);
            }
        }
        return;
    }
    /** Find a field by full key path  */
    findField(field, fields, parent) {
        if (!field || !fields) {
            return;
        }
        const fullPathByField = new Map();
        const newPath = this.getFullKeyPath(parent || {}, fields).concat(getKeyPath(field));
        const length = newPath.length;
        return this.traverseFields(fields, (f, p) => {
            const path = fullPathByField.get(f) || fullPathByField.set(f, (p || []).concat(getKeyPath(f))).get(f);
            if (path?.length !== length) {
                return;
            }
            for (let i = 0; i < length; i++) {
                if (path[i] === newPath[i]) {
                    return f;
                }
            }
            return;
        });
    }
    mutateField(field, editorField) {
        field.templateOptions = { ...field.templateOptions };
        if (!editorField && !field.templateOptions['$designerId']) {
            field.templateOptions['$designerId'] = generateUuid();
        }
        if (field.fieldGroup) {
            this.mutateFields(field.fieldGroup, editorField);
        }
        else if (field.fieldArray && field.fieldArray.fieldGroup) {
            if (editorField) {
                this.mutateField(field.fieldArray, editorField);
            }
            else {
                // Treating fieldArrays as fieldGroups
                // Treating fieldArrays as fieldGroups
                field.templateOptions['$fieldArray'] = { type: field.type };
                field.fieldGroup = field.fieldArray.fieldGroup;
                delete field.fieldArray;
                delete field.type;
                this.mutateFields(field.fieldGroup, editorField);
            }
        }
        return field;
    }
    mutateFields(fields, editorFields) {
        fields.forEach(field => this.mutateField(field, editorFields));
    }
    traverseFields(fields, callback, path, parent) {
        path = path || [];
        for (const field of fields) {
            const value = callback(field, path, parent);
            if (value) {
                return value;
            }
            if (field.fieldArray) {
                const arrayValue = this.traverseFields([field.fieldArray], callback, path.concat(getKeyPath(field)), field);
                if (arrayValue) {
                    return arrayValue;
                }
            }
            else if (field.fieldGroup) {
                const groupValue = this.traverseFields(field.fieldGroup, callback, path.concat(getKeyPath(field)), field);
                if (groupValue) {
                    return groupValue;
                }
            }
        }
    }
    getFields(name, type) {
        const fields = this.getDesignerOptions(type)[name]?.fields;
        if (!fields) {
            return [];
        }
        this.mutateFields(cloneDeep(fields), true);
        return fields;
    }
    getDesignerOptions(type) {
        if (type === 'type') {
            return this.formlyDesignerConfig.types;
        }
        if (type === 'wrapper') {
            return this.formlyDesignerConfig.wrappers;
        }
        return {};
    }
}
FieldsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.6", ngImport: i0, type: FieldsService, deps: [{ token: i1.FormlyDesignerConfig }], target: i0.ɵɵFactoryTarget.Injectable });
FieldsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.6", ngImport: i0, type: FieldsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.6", ngImport: i0, type: FieldsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.FormlyDesignerConfig }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtZm9ybWx5LWRlc2lnbmVyL3NyYy9saWIvZmllbGRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxRQUFRLENBQUM7OztBQUczRixNQUFNLE9BQU8sYUFBYTtJQUN4QixZQUNVLG9CQUEwQztRQUExQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO0lBQ2hELENBQUM7SUFFTCxjQUFjLENBQUMsS0FBd0IsRUFBRSxNQUEyQjtRQUNsRSxJQUFJLE9BQU8sR0FBd0IsRUFBRSxDQUFDO1FBQ3RDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDdEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQXdDLENBQUM7WUFDaEUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUM5QyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDbkMsQ0FBQyxDQUFDLENBQUM7WUFFSCxPQUFPLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzVCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDN0IsT0FBTyxHQUFHLEVBQUU7Z0JBQ1YsT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzFDLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFD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TSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0MsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVPLGtCQUFrQixDQUFDLElBQVk7UUFDckMsSUFBSSxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQztTQUN4QztRQUNELElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtZQUN0QixPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUM7U0FDM0M7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7OzBHQWxLVSxhQUFhOzhHQUFiLGFBQWE7MkZBQWIsYUFBYTtrQkFEekIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1seUZpZWxkQ29uZmlnIH0gZnJvbSAnQG5neC1mb3JtbHkvY29yZSc7XG5pbXBvcnQgeyBEZXNpZ25lck9wdGlvbiwgRm9ybWx5RGVzaWduZXJDb25maWcgfSBmcm9tICcuL2Zvcm1seS1kZXNpZ25lci1jb25maWcnO1xuaW1wb3J0IHsgY2xvbmVEZWVwLCBlcXVhbFR5cGUsIGdlbmVyYXRlVXVpZCwgZ2V0S2V5UGF0aCwgaXNBcnJheSwgaXNTdHJpbmcgfSBmcm9tICcuL3V0aWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRmllbGRzU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZm9ybWx5RGVzaWduZXJDb25maWc6IEZvcm1seURlc2lnbmVyQ29uZmlnXG4gICkgeyB9XG5cbiAgZ2V0RnVsbEtleVBhdGgoZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBmaWVsZHM6IEZvcm1seUZpZWxkQ29uZmlnW10pOiAoc3RyaW5nIHwgbnVtYmVyKVtdIHtcbiAgICBsZXQga2V5UGF0aDogKHN0cmluZyB8IG51bWJlcilbXSA9IFtdO1xuICAgIGlmIChmaWVsZCAmJiBmaWVsZC5rZXkpIHtcbiAgICAgIGNvbnN0IHBhcmVudHMgPSBuZXcgTWFwPEZvcm1seUZpZWxkQ29uZmlnLCBGb3JtbHlGaWVsZENvbmZpZz4oKTtcbiAgICAgIHRoaXMudHJhdmVyc2VGaWVsZHMoZmllbGRzLCAoZiwgcGF0aCwgcGFyZW50KSA9PiB7XG4gICAgICAgIHBhcmVudCAmJiBwYXJlbnRzLnNldChmLCBwYXJlbnQpO1xuICAgICAgfSk7XG5cbiAgICAgIGtleVBhdGggPSBnZXRLZXlQYXRoKGZpZWxkKTtcbiAgICAgIGxldCBjdXIgPSBwYXJlbnRzLmdldChmaWVsZCk7XG4gICAgICB3aGlsZSAoY3VyKSB7XG4gICAgICAgIGtleVBhdGggPSBnZXRLZXlQYXRoKGN1cikuY29uY2F0KGtleVBhdGgpO1xuICAgICAgICBjdXIgPSBwYXJlbnRzLmdldChjdXIpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ga2V5UGF0aDtcbiAgfVxuXG4gIGdldFR5cGVGaWVsZHModHlwZTogc3RyaW5nKTogRm9ybWx5RmllbGRDb25maWdbXSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RmllbGRzKHR5cGUsICd0eXBlJyk7XG4gIH1cblxuICBnZXRXcmFwcGVyRmllbGRzKHdyYXBwZXI6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQpOiBGb3JtbHlGaWVsZENvbmZpZ1tdIHtcbiAgICByZXR1cm4gd3JhcHBlciA/IHRoaXMuZ2V0RmllbGRzKHdyYXBwZXIsICd3cmFwcGVyJykgOiBbXTtcbiAgfVxuXG4gIGNoZWNrRmllbGQoZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnLCBmaWVsZHM6IEZvcm1seUZpZWxkQ29uZmlnW10sIHBhcmVudD86IEZvcm1seUZpZWxkQ29uZmlnKTogYm9vbGVhbiB7XG4gICAgaWYgKGZpZWxkLmtleSA9PSBudWxsIHx8IChpc1N0cmluZyhmaWVsZC5rZXkpICYmICFmaWVsZC5rZXkpIHx8IChpc0FycmF5KGZpZWxkLmtleSkgJiYgIWZpZWxkLmtleS5sZW5ndGgpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgZnVsbFBhdGhCeUZpZWxkID0gbmV3IE1hcDxGb3JtbHlGaWVsZENvbmZpZywgKHN0cmluZyB8IG51bWJlcilbXT4oKTtcbiAgICBjb25zdCBuZXdQYXRoID0gdGhpcy5nZXRGdWxsS2V5UGF0aChwYXJlbnQgfHwge30sIGZpZWxkcykuY29uY2F0KGdldEtleVBhdGgoZmllbGQpKTtcbiAgICBjb25zdCBsZW5ndGggPSBuZXdQYXRoLmxlbmd0aDtcbiAgICByZXR1cm4gIXRoaXMudHJhdmVyc2VGaWVsZHMoZmllbGRzLCAoZiwgcCkgPT4ge1xuICAgICAgY29uc3QgcGF0aCA9IGZ1bGxQYXRoQnlGaWVsZC5nZXQoZikgfHwgZnVsbFBhdGhCeUZpZWxkLnNldChmLCAocCB8fCBbXSkuY29uY2F0KGdldEtleVBhdGgoZikpKS5nZXQoZik7XG4gICAgICBpZiAocGF0aD8ubGVuZ3RoICE9PSBsZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAocGF0aFtpXSAhPT0gbmV3UGF0aFtpXSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuICFlcXVhbFR5cGUoZmllbGQsIGYpO1xuICAgIH0pO1xuICB9XG5cbiAgZmluZChpZDogc3RyaW5nIHwgbnVsbCwgZmllbGRzPzogRm9ybWx5RmllbGRDb25maWdbXSk6IEZvcm1seUZpZWxkQ29uZmlnIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIWlkIHx8ICFpc0FycmF5KGZpZWxkcykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3Qgc3RhY2sgPSBmaWVsZHMuc2xpY2UoKTtcbiAgICB3aGlsZSAoc3RhY2subGVuZ3RoKSB7XG4gICAgICBjb25zdCBmaWVsZCA9IHN0YWNrLnBvcCgpIGFzIEZvcm1seUZpZWxkQ29uZmlnO1xuICAgICAgaWYgKGZpZWxkLnRlbXBsYXRlT3B0aW9ucz8uWyckZGVzaWduZXJJZCddID09PSBpZCkge1xuICAgICAgICByZXR1cm4gZmllbGQ7XG4gICAgICB9XG4gICAgICBpZiAoZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgICBzdGFjay5wdXNoKGZpZWxkLmZpZWxkQXJyYXkpO1xuICAgICAgfSBlbHNlIGlmIChmaWVsZC5maWVsZEdyb3VwKSB7XG4gICAgICAgIHN0YWNrLnB1c2goLi4uZmllbGQuZmllbGRHcm91cCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKiBGaW5kIGEgZmllbGQgYnkgZnVsbCBrZXkgcGF0aCAgKi9cbiAgZmluZEZpZWxkKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdLCBwYXJlbnQ/OiBGb3JtbHlGaWVsZENvbmZpZyk6IEZvcm1seUZpZWxkQ29uZmlnIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIWZpZWxkIHx8ICFmaWVsZHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZnVsbFBhdGhCeUZpZWxkID0gbmV3IE1hcDxGb3JtbHlGaWVsZENvbmZpZywgKHN0cmluZyB8IG51bWJlcilbXT4oKTtcbiAgICBjb25zdCBuZXdQYXRoID0gdGhpcy5nZXRGdWxsS2V5UGF0aChwYXJlbnQgfHwge30sIGZpZWxkcykuY29uY2F0KGdldEtleVBhdGgoZmllbGQpKTtcbiAgICBjb25zdCBsZW5ndGggPSBuZXdQYXRoLmxlbmd0aDtcbiAgICByZXR1cm4gdGhpcy50cmF2ZXJzZUZpZWxkcyhmaWVsZHMsIChmLCBwKSA9PiB7XG4gICAgICBjb25zdCBwYXRoID0gZnVsbFBhdGhCeUZpZWxkLmdldChmKSB8fCBmdWxsUGF0aEJ5RmllbGQuc2V0KGYsIChwIHx8IFtdKS5jb25jYXQoZ2V0S2V5UGF0aChmKSkpLmdldChmKTtcbiAgICAgIGlmIChwYXRoPy5sZW5ndGggIT09IGxlbmd0aCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChwYXRoW2ldID09PSBuZXdQYXRoW2ldKSB7XG4gICAgICAgICAgcmV0dXJuIGY7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9KTtcbiAgfVxuXG4gIG11dGF0ZUZpZWxkKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgZWRpdG9yRmllbGQ6IGJvb2xlYW4pOiBGb3JtbHlGaWVsZENvbmZpZyB7XG4gICAgZmllbGQudGVtcGxhdGVPcHRpb25zID0geyAuLi5maWVsZC50ZW1wbGF0ZU9wdGlvbnMgfTtcbiAgICBpZiAoIWVkaXRvckZpZWxkICYmICFmaWVsZC50ZW1wbGF0ZU9wdGlvbnNbJyRkZXNpZ25lcklkJ10pIHtcbiAgICAgIGZpZWxkLnRlbXBsYXRlT3B0aW9uc1snJGRlc2lnbmVySWQnXSA9IGdlbmVyYXRlVXVpZCgpO1xuICAgIH1cbiAgICBpZiAoZmllbGQuZmllbGRHcm91cCkge1xuICAgICAgdGhpcy5tdXRhdGVGaWVsZHMoZmllbGQuZmllbGRHcm91cCwgZWRpdG9yRmllbGQpO1xuICAgIH0gZWxzZSBpZiAoZmllbGQuZmllbGRBcnJheSAmJiBmaWVsZC5maWVsZEFycmF5LmZpZWxkR3JvdXApIHtcbiAgICAgIGlmIChlZGl0b3JGaWVsZCkge1xuICAgICAgICB0aGlzLm11dGF0ZUZpZWxkKGZpZWxkLmZpZWxkQXJyYXksIGVkaXRvckZpZWxkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRyZWF0aW5nIGZpZWxkQXJyYXlzIGFzIGZpZWxkR3JvdXBzXG4gICAgICAgIC8vIFRyZWF0aW5nIGZpZWxkQXJyYXlzIGFzIGZpZWxkR3JvdXBzXG4gICAgICAgIGZpZWxkLnRlbXBsYXRlT3B0aW9uc1snJGZpZWxkQXJyYXknXSA9IHsgdHlwZTogZmllbGQudHlwZSB9O1xuICAgICAgICBmaWVsZC5maWVsZEdyb3VwID0gZmllbGQuZmllbGRBcnJheS5maWVsZEdyb3VwO1xuICAgICAgICBkZWxldGUgZmllbGQuZmllbGRBcnJheTtcbiAgICAgICAgZGVsZXRlIGZpZWxkLnR5cGU7XG5cbiAgICAgICAgdGhpcy5tdXRhdGVGaWVsZHMoZmllbGQuZmllbGRHcm91cCwgZWRpdG9yRmllbGQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmllbGQ7XG4gIH1cblxuICBtdXRhdGVGaWVsZHMoZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdLCBlZGl0b3JGaWVsZHM6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBmaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB0aGlzLm11dGF0ZUZpZWxkKGZpZWxkLCBlZGl0b3JGaWVsZHMpKTtcbiAgfVxuXG4gIHRyYXZlcnNlRmllbGRzKGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXSxcbiAgICBjYWxsYmFjazogKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZywgcGF0aD86IChzdHJpbmcgfCBudW1iZXIpW10sIHBhcmVudD86IEZvcm1seUZpZWxkQ29uZmlnKSA9PiBib29sZWFuIHwgYW55LFxuICAgIHBhdGg/OiAoc3RyaW5nIHwgbnVtYmVyKVtdLFxuICAgIHBhcmVudD86IEZvcm1seUZpZWxkQ29uZmlnKTogYm9vbGVhbiB8IGFueSB7XG4gICAgcGF0aCA9IHBhdGggfHwgW107XG4gICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gY2FsbGJhY2soZmllbGQsIHBhdGgsIHBhcmVudCk7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfVxuICAgICAgaWYgKGZpZWxkLmZpZWxkQXJyYXkpIHtcbiAgICAgICAgY29uc3QgYXJyYXlWYWx1ZSA9IHRoaXMudHJhdmVyc2VGaWVsZHMoW2ZpZWxkLmZpZWxkQXJyYXldLCBjYWxsYmFjaywgcGF0aC5jb25jYXQoZ2V0S2V5UGF0aChmaWVsZCkpLCBmaWVsZCk7XG4gICAgICAgIGlmIChhcnJheVZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuIGFycmF5VmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZmllbGQuZmllbGRHcm91cCkge1xuICAgICAgICBjb25zdCBncm91cFZhbHVlID0gdGhpcy50cmF2ZXJzZUZpZWxkcyhmaWVsZC5maWVsZEdyb3VwLCBjYWxsYmFjaywgcGF0aC5jb25jYXQoZ2V0S2V5UGF0aChmaWVsZCkpLCBmaWVsZCk7XG4gICAgICAgIGlmIChncm91cFZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuIGdyb3VwVmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpZWxkcyhuYW1lOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IEZvcm1seUZpZWxkQ29uZmlnW10ge1xuICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuZ2V0RGVzaWduZXJPcHRpb25zKHR5cGUpW25hbWVdPy5maWVsZHM7XG4gICAgaWYgKCFmaWVsZHMpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdGhpcy5tdXRhdGVGaWVsZHMoY2xvbmVEZWVwKGZpZWxkcyksIHRydWUpO1xuICAgIHJldHVybiBmaWVsZHM7XG4gIH1cblxuICBwcml2YXRlIGdldERlc2lnbmVyT3B0aW9ucyh0eXBlOiBzdHJpbmcpOiB7IFtuYW1lOiBzdHJpbmddOiBEZXNpZ25lck9wdGlvbiB9IHtcbiAgICBpZiAodHlwZSA9PT0gJ3R5cGUnKSB7XG4gICAgICByZXR1cm4gdGhpcy5mb3JtbHlEZXNpZ25lckNvbmZpZy50eXBlcztcbiAgICB9XG4gICAgaWYgKHR5cGUgPT09ICd3cmFwcGVyJykge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybWx5RGVzaWduZXJDb25maWcud3JhcHBlcnM7XG4gICAgfVxuICAgIHJldHVybiB7fTtcbiAgfVxufVxuIl19